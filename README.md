#  AnotherSearchEngine (ещё один поисковый движок)

Реализация поискового движка, который осуществляет:  
-  обход всех страниц заданных сайтов;
-  индексацию найденных страниц;
-  выдачу наиболее релевантных страниц заданных сайтов по поисковому запросу на русском и английском языках.

##  Стек используемых технологий  
-  разработка: Java 13.0.2, Spring Boot 2.7.1;  
-  сборка: Maven 3.6.3;  
-  база данных: MySQL 8.0.22;  
-  API: REST;  
-  система контроля версий: Git 2.27.0.

##  Использование сторонних проектов  

###  Проект-заготовка  
Для разработки данного приложения использовался проект-заготовка, который находится в репозитории по [ссылке](https://github.com/sortedmap/searchengine).

---  

###  Лемматизатор  
Лемматизатор — это специальная библиотека, которая позволяет получать леммы слов - их исходные формы (для существительных, например, это слово в именительном падеже и единственном числе).  
К проекту подключен лемматизатор для русского и английского языков, [ссылка](https://github.com/AKuznetsov/russianmorphology).  

##  Описание  

###  Работа приложения  

-  вкладка `DASHBOARD`  
Эта вкладка открывается по умолчанию. На ней отображается общая статистика по всем сайтам:  

   -  количество сайтов, указанных в файле конфигрурации;  
   -  количество страниц по всем проиндексированным сайтам;  
   -  количество лемм по всем проиндексированным сайтам;  
   -  список всех сайтов, указанных в файле конфигрурации, а также их статус.  

   Возможные статусы сайтов:

   -  `INDEXING` - индексация сайта не была ни разу запущена, либо находится в процессе;  
   -  `INDEXED` - сайт удачно проиндексирован;  
   -  `FAILED` - индексация сайта была остановлена, либо завершилась ошибкой.  
      
   Также для каждого сайта из списка доступна детальная статистика:  
   
   -  время последнего изменения статуса;  
   -  количество страниц;
   -  количество лемм;  
   -  последняя ошибка при индексации (если статус `FAILED`).

   ![DASHBOARD](/images/Dashboard.png)

-  вкладка `MANAGEMENT`  
На этой вкладке находятся инструменты управления индексацией.  
Возможные действия:  

   -  запуск индексации / переиндексации всех сайтов из файла конфигурации; для этого необходимо нажать кнопку `START INDEXING`. После запуска индексации название кнопки поменяется на `STOP INDEXING`;  
   -  остановка процесса индексации; для этого необходимо нажать кнопку `STOP INDEXING`;  
   -  добавление / обновление отдельной страницы; для этого необходимо вставить ссылку в поле `Add/update page` и нажать кнопку `ADD/UPDATE`; выполнение данного действия доступно только в случае, если добавляемая / обновляемая страница относится к одному из сайтов списка.

   ![MANAGEMENT](/images/Management.png)


-  Вкладка `SEARCH`  
Вкладка поиска. Для осуществления поиска необходимо в выпадющем списке выбрать сайт, по которому искать, либо оставить `All sites` для поиска по всем сайтам и ввести поисковый запрос в поле `Query`. После нажатия на кнопку `SEARCH` будут выведены результаты поиска.  

   ![SEARCH](/images/Search.png)

---


###  API

-  Запуск индексации - ***GET*** `/startIndexing`  
   
   **Параметры:**
  
   *Метод без параметров*  
   
   **Формат ответа в случае успеха:**  

       {'result': true}
        
   **Формат ответа в случае ошибки:**  

       {'result': false,
       'error': "Индексация уже запущена"}

-  Остановка текущей индексации - ***GET*** `/stopIndexing`
   
   **Параметры:**
   
   *Метод без параметров.*
   
   **Формат ответа в случае успеха:**  

       {'result': true}

   **Формат ответа в случае ошибки:**  

       {'result': false,
       'error': "Индексация не запущена"}

-  Добавление или обновление отдельной страницы - ***POST*** `/indexPage`
   
   **Параметры:**
   
   -  *url - адрес страницы, которую нужно переиндексировать.*  

   **Формат ответа в случае успеха:**  

       {'result': true}

   **Формат ответа в случае ошибки:**  

       {'result': false,
       'error': "Данная страница находится за пределами сайтов, указанных в конфигурационном файле"}

-  Статистика - ***GET*** `/statistics`
   
   **Параметры:**
   
   *Метод без параметров.*
   
   **Формат ответа:**  

       {'result': true,
       'statistics':
              {"total":
                     {"sites": 10,
                     "pages": 436423,
                     "lemmas": 5127891,
                     "isIndexing": true},
              "detailed":
                     [{"url": "http://www.site.com",
                     "name": "Имя сайта",
                     "status": "INDEXED",
                     "statusTime": 1600160357,
                     "error": "Ошибка индексации: главная страница сайта недоступна",
                     "pages": 5764,
                     "lemmas": 321115},
                     ...
                     ]
              }
       }

-  Получение данных по поисковому запросу - ***GET*** `/search`
   
   **Параметры:**
   
   -  *query - поисковый запрос;*  
   -  *site - сайт, по которому осуществлять поиск (если не задан, поиск должен происходить по всем проиндексированным сайтам); задаётся в формате адреса, например: http://www.site.com (без слэша в конце);*  
   -  *offset - сдвиг от 0 для постраничного вывода (параметр необязательный, если не установлен, то значение по умолчанию равно нулю);*  
   -  *limit - количество результатов, которое необходимо вывести (параметр необязательный, если не установлен, то значение по умолчанию равно 20-ти).*  
   
   **Формат ответа в случае успеха:**   

       {'result': true,
       'count': 574,
       'data':
              [{"site": "http://www.site.com",
              "siteName": "Имя сайта",
              "uri": "/path/to/page/6784",
              "title": "Заголовок страницы,которую выводим",
              "snippet": "Фрагмент текста, в котором найдены совпадения, <b>выделенные жирным</b>, в формате HTML",
              "relevance": 0.93362},
              ...
              ]
       }

   **Формат ответа в случае ошибки:**  

       {'result': false,
       'error': "Задан пустой поисковый запрос"}

---  


###  Конфигурационный файл (application.yaml)
Конфигурационный файл содержит:  

-  пользовательские переменные - `indexing-settings`:

   -  перечень сайтов, которые необходимо индексировать - `sites`; для каждого сайта задаются адрес - `url` и имя - `name`;
  
-  пользовательские переменные - `indexing-config`:

   -  имя user-agent, который необходимо подставлять при запросах страниц сайтов - `userAgent`;
   -  referrer, который необходимо подставлять при запросах страниц сайтов - `referrer`;
   -  размер буфера, использующегося при сохранении страниц - `pageBufferSize`;
   -  размер буфера, использующегося при сохранении лемм - `lemmaBufferSize`;
   -  размер буфера, использующегося при сохранении поисковых индексов - `indexBufferSize`;
   -  пороговое значение коэффициента встречаемости леммы на сайте - `lemmaOccurrenceLimit`;
   
-  свойства подключения к базе данных: хост, порт, имя базы - `spring:datasource:url`;
-  свойства подключения к базе данных: логин - `spring:datasource:username`;
-  свойства подключения к базе данных: пароль - `spring:datasource:password`;
-  диалект Hibernate - `spring:jpa:properties:hibernate:dialect`;
-  режим управления структурой базы данных - `spring:jpa:hibernate:ddl-auto`.

Пример заполненного файла application.yaml:  

    # Перечень сайтов
    indexing-settings:
      sites:
        - url: https://www.svetlovka.ru/
          name: Библиотека имени М. А. Светлова
        - url: https://prestonparkmuseum.co.uk/
          name: Preston park
        - url: https://ipfran.ru/
          name: Институт прикладной физики им. А.В. Гапонова-Грехова

    indexing-config:
      # Свойства User Agent
      userAgent: another search engine bot
      referrer: http://www.google.com
      # Размер буферов для сохранения в БД
      pageBufferSize: 100
      lemmaBufferSize: 1000
      indexBufferSize: 5000

      # Пороговое значение коэффициента встречаемости леммы на сайте - значение при котором лемма исключается из поиска
      # коэффициента встречаемости леммы на сайте = количество страниц, на которых встречается лемма / общее число страниц на сайте
      lemmaOccurrenceLimit: 0.75

    # Свойства подключения к БД
    spring:
      datasource:
        url: jdbc:mysql://localhost:3306/search_engine?useSSL=false&requireSSL=false&allowPublicKeyRetrieval=true
        username: bestuser
        password: bestuser

      jpa:
        properties:
          hibernate:
            dialect: org.hibernate.dialect.MySQL8Dialect
        hibernate:
          ddl-auto: none
    
---  


###  Таблицы в базе данных

-  **site** - информация о сайтах и статусах их индексации  
   - id INT NOT NULL AUTO_INCREMENT;  
   - status ENUM('INDEXING', 'INDEXED', 'FAILED') NOT NULL — текущий статус полной индексации сайта, отражающий готовность поискового движка осуществлять поиск по сайту - индексация или переиндексация в процессе, сайт полностью проиндексирован (готов к поиску) или не удалось проиндексировать (сайт не готов к поиску и не будет до устранения ошибок и перезапуска индексации);  
   - status_time DATETIME NOT NULL — дата и время статуса (в случае статуса INDEXING дата и время обновляются регулярно при добавлении каждой новой страницы в индекс);  
   - last_error TEXT — текст ошибки индексации или NULL, если её не было;  
   - url VARCHAR(255) NOT NULL — адрес главной страницы сайта;  
   - name VARCHAR(255) NOT NULL — имя сайта.
-  **page** - проиндексированные страницы сайта  
   -  id INT NOT NULL AUTO_INCREMENT;
   -  site_id INT NOT NULL — ID веб-сайта из таблицы site;
   -  path TEXT NOT NULL - адрес страницы от корня сайта (должен начинаться со слеша, например: /news/372189/);
   -  code INT NOT NULL - код ответа, полученный при запросе страницы (например, 200, 404, 500 или другие);
   -  content MEDIUMTEXT NOT NULL - контент страницы (HTML-код).
-  **lemma** - леммы, встречающиеся в текстах  
   - id INT NOT NULL AUTO_INCREMENT;
   - site_id INT NOT NULL — ID веб-сайта из таблицы site;
   - lemma VARCHAR(255) NOT NULL — нормальная форма слова;
   - frequency INT NOT NULL — количество страниц, на которых слово встречается хотя бы один раз. Максимальное значение не может превышать общее количество слов на сайте.
-  **index** - поисковый индекс  
   - id INT NOT NULL AUTO_INCREMENT;
   - page_id INT NOT NULL — идентификатор страницы;
   - lemma_id INT NOT NULL — идентификатор леммы;
   - rank FLOAT NOT NULL — количество данной леммы для данной страницы.


##  Запуск проекта локально  
Для запуска проекта необходимо:  
1.  создать папку, в которую будут склонированы исходники и выполнить команду:  

        git clone https://github.com/Alexander-ILIN/another-searchengine.git

2.  открыть проект `File --> Open ...`  

    ![OPEN_PROJECT](/images/OpenProject.png)

3.  запустить команду `package` у корневого Maven-проекта `AnotherSearchEngine`, либо в командной строке в корне проекта выполнить команду:  

        mvn package  

    ![PACKAGE](/images/MavenPackage.png)

4.  убедиться, что сборка прошла успешно:  

    ![BUILD_SUCCESS](/images/BuildSuccess.png)

5. скопировать в одну папку получившийся `.jar` файл из папки `target`, а также файл `application.yaml` из корневой папки проекта:  

    ![COPY_TO_FOLDER](/images/CopyToFolder.png)

6. создать новую схему в базе данных (при необходимости):  

    ![DB_SCHEMA](/images/DbSchema.png)

7. заполнить параметры файла `application.yaml`:  

    ![PROPERTIES](/images/Properties.png)

   перед первым запуском необходимо установить свойство (данный шаг можно пропустить, если таблицы в базе данных будут создаваться вручную):

        spring.jpa.hibernate.ddl-auto: create
